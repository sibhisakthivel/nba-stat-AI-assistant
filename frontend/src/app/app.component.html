<div class="app-wrapper" [class.dark-mode]="isDarkMode">
  <div class="app-container">
    <div class="header-container">
      <h1>NBA Stat AI Assistant</h1>
      <button class="theme-toggle" (click)="toggleTheme()" [attr.aria-label]="isDarkMode ? 'Switch to light mode' : 'Switch to dark mode'">
        <span class="theme-icon">{{ isDarkMode ? '☀️' : '🌙' }}</span>
      </button>
    </div>
    <div class="main-container">
      <div class="chats-panel">
        <div class="chats-header">
          <h3>Chats</h3>
          <button class="new-chat-btn" (click)="createNewChat()">+ New Chat</button>
        </div>
        <div class="chats-list">
          <div *ngFor="let chat of chats; let i = index" 
               class="chat-item"
               [class.active]="currentChatIndex === i"
               [class.pinned]="chat.pinned"
               (click)="switchChat(i)">
            <input *ngIf="editingChatIndex === i"
                   class="chat-title-input"
                   [(ngModel)]="chat.title"
                   (blur)="stopEditing()"
                   (keyup.enter)="stopEditing()"
                   (keyup.escape)="cancelEditing(i)"
                   (click)="$event.stopPropagation()"
                   #chatInput />
            <span *ngIf="editingChatIndex !== i" 
                  class="chat-title">{{ chat.title }}</span>
            <div class="chat-actions" *ngIf="editingChatIndex !== i">
              <button class="action-btn pin-btn" 
                      (click)="togglePin(i, $event)"
                      [class.pinned]="chat.pinned"
                      title="Pin chat">
                📌
              </button>
              <button class="action-btn rename-btn" 
                      (click)="startEditing(i, $event)"
                      title="Rename chat">
                ✏️
              </button>
              <button class="action-btn delete-btn" 
                      (click)="deleteChat(i, $event)"
                      title="Delete chat">
                🗑️
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-container">
        <div class="messages">
          <div *ngFor="let msg of getCurrentChat()?.messages" class="message-wrapper" [ngClass]="msg.sender">
            <div class="message-bubble">
              {{ msg.text }}
            </div>
          </div>
          <div *ngIf="isLoading" class="message-wrapper bot">
            <div class="message-bubble loading-bubble">
              <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </div>
        </div>
        <form (ngSubmit)="sendMessage()" class="input-area">
          <input [(ngModel)]="userInput" name="userInput" placeholder="Type a message..." />
          <button type="submit" aria-label="Send message">→</button>
        </form>
      </div>
      <div class="evidence-panel">
        <h3>Evidence</h3>
        <div class="evidence-list">
          <ng-container *ngFor="let msg of getCurrentChat()?.messages; let i = index">
            <ng-container *ngIf="msg.sender === 'bot' && msg.evidence && msg.evidence.length > 0">
              <div *ngFor="let ev of msg.evidence; let j = index"
                   class="evidence-item"
                   [class.expanded]="expandedEvidence[currentChatIndex + '_' + i + '_' + j]"
                   [class.pinned]="ev.pinned"
                   (click)="toggleEvidence(currentChatIndex + '_' + i + '_' + j)">
                <div class="evidence-header">
                  <span class="evidence-title">{{ ev.display_name }}</span>
                  <div class="evidence-actions">
                    <button class="action-btn pin-btn" 
                            (click)="toggleEvidencePin(i, j, $event)"
                            [class.pinned]="ev.pinned"
                            title="Pin evidence">
                      📌
                    </button>
                    <button class="action-btn delete-btn" 
                            (click)="deleteEvidence(i, j, $event)"
                            title="Delete evidence">
                      🗑️
                    </button>
                    <span class="evidence-arrow">{{ expandedEvidence[currentChatIndex + '_' + i + '_' + j] ? '▼' : '▶' }}</span>
                  </div>
                </div>
                <div *ngIf="expandedEvidence[currentChatIndex + '_' + i + '_' + j]" class="evidence-details">
                  <div class="game-info" *ngIf="ev.table === 'game_details'">
                    <div class="evidence-label">{{ ev.home_team }} vs {{ ev.away_team }}</div>
                    <div>Score: {{ ev.home_points }} - {{ ev.away_points }}</div>
                    <div>Date: {{ ev.game_date }}</div>
                  </div>
                  <div class="player-info" *ngIf="ev.table === 'player_box_scores'">
                    <div class="evidence-label">{{ ev.player_name }}</div>
                    <div>Team: {{ ev.team }}</div>
                    <div>Points: {{ ev.points }}</div>
                    <div *ngIf="ev.rebounds">Rebounds: {{ ev.rebounds }}</div>
                    <div *ngIf="ev.assists">Assists: {{ ev.assists }}</div>
                  </div>
                </div>
              </div>
            </ng-container>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</div>